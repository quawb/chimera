<!doctype html> 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chimera — Warband Builder (Prototype)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; line-height: 1.35; }
    h1 { margin: 0 0 8px; }
    .sub { color: #444; margin: 0 0 24px; }
    .row { display: grid; grid-template-columns: 240px 1fr; gap: 12px; align-items: center; margin-bottom: 12px; }
    select, input { font-size: 16px; padding: 8px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin-top: 16px; max-width: 820px; }
    .grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; margin-top: 12px; }
    .pill { display: inline-block; border: 1px solid #ddd; border-radius: 999px; padding: 4px 10px; margin: 4px 6px 0 0; font-size: 14px; }
    .warn { color: #8a1f11; font-weight: 600; }
    .ok { color: #0b5; font-weight: 600; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>

<body>
  <h1>Chimera Builder (Prototype)</h1>
  <p class="sub">Loads <code>data/shoot.json</code> and <code>data/accessories.json</code>. Select a weapon + accessories and see points update.</p>
. Select a ranged weapon and see stats + points update.</p>



  <div class="row">
    <label for="pointCap"><strong>Point Cap</strong></label>
    <input id="pointCap" type="number" value="75" min="0" step="1" />
  </div>



    <div class="card">
    <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;">
      <div>
        <div style="font-size:18px; font-weight:800;">Warband</div>
        <div style="color:#444; margin-top:4px;">Leader + 4 models. Each model has its own weapon + accessories.</div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="exportBtn" type="button">Export Warband</button>
        <button id="importBtn" type="button">Import Warband</button>
      </div>
    </div>

      <div class="row" style="margin-top:10px;">
  <label for="warbandTraitSelect"><strong>Warband Trait</strong></label>
  <select id="warbandTraitSelect">
    <option value="">Loading…</option>
  </select>
</div>

<div class="row" style="margin-top:10px;">
  <label for="leaderTraitSelect"><strong>Leader Trait</strong></label>
  <select id="leaderTraitSelect">
    <option value="">Loading…</option>
  </select>
</div>

      
    <div id="warbandGrid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; margin-top:14px;"></div>

    <div style="margin-top:14px;">
      <div style="font-size:14px; color:#444;">Warband Total</div>
      <div style="font-size:28px; font-weight:900;" id="warbandTotal">0</div>
      <div id="warbandCapStatus" style="margin-top:6px;"></div>
    </div>

    <div id="ioArea" style="display:none; margin-top:14px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <strong id="ioTitle">Export / Import</strong>
        <button id="closeIoBtn" type="button">Close</button>
      </div>
      <textarea id="ioText" rows="10" style="width:100%; margin-top:8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 13px; padding:10px;"></textarea>
      <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
        <button id="copyBtn" type="button">Copy</button>
        <button id="loadBtn" type="button">Load Pasted JSON</button>
      </div>
      <div id="ioMsg" style="margin-top:8px; color:#444;"></div>
    </div>
  </div>


  <div class="card" id="errorCard" style="display:none;">
    <div class="warn">Could not load shoot.json</div>
    <p id="errorText" style="margin:8px 0 0;"></p>
    <p style="margin:8px 0 0;">
      Expected path: <code>site/data/shoot.json</code>
    </p>
  </div>

<script>
  const els = {
    pointCap: document.getElementById("pointCap"),
    warbandGrid: document.getElementById("warbandGrid"),
    warbandTotal: document.getElementById("warbandTotal"),
    warbandCapStatus: document.getElementById("warbandCapStatus"),

    warbandTraitSelect: document.getElementById("warbandTraitSelect"),
    leaderTraitSelect: document.getElementById("leaderTraitSelect"),


    exportBtn: document.getElementById("exportBtn"),
    importBtn: document.getElementById("importBtn"),
    ioArea: document.getElementById("ioArea"),
    ioTitle: document.getElementById("ioTitle"),
    ioText: document.getElementById("ioText"),
    copyBtn: document.getElementById("copyBtn"),
    loadBtn: document.getElementById("loadBtn"),
    closeIoBtn: document.getElementById("closeIoBtn"),
    ioMsg: document.getElementById("ioMsg"),

    errorCard: document.getElementById("errorCard"),
    errorText: document.getElementById("errorText"),
  };

  function toIntOrNull(v) {
    if (v === null || v === undefined) return null;
    const s = String(v).trim();
    if (s === "") return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // Data tables (loaded from JSON)
  let weapons = [];
  let accessories = [];
  let psychicPowers = [];
  let mutations = [];
  let meleeWeapons = [];
  let warbandTraits = [];
  let leaderTraits = [];


  // === Rules (hardwired for now, easy to change) ===
  const DEFENSE_TO_ACC_CAP = { 0: 0, 1: 1, 2: 2, 3: 3 };
  const SIDEARM_UNLOCK_SHOOT_TIER = 3;

  // === Stat costs + modifiers (hard-coded) ===
  const DEF_WILL_TABLE = {
    0: { mod: -2, cost: 0 },
    1: { mod: 0,  cost: 2 },
    2: { mod: 2,  cost: 4 },
    3: { mod: 4,  cost: 8 },
  };

  const SHOOT_FIGHT_TABLE = {
    0: { mod: -2, cost: 0 },
    1: { mod: -2, cost: 0 },
    2: { mod: 2,  cost: 3 },
    3: { mod: 4,  cost: 6 },
  };

  const SAVE_TARGET_BY_WILL = { 0: 14, 1: 14, 2: 13, 3: 11 };

  function clampMin(n, min) { return n < min ? min : n; }

  function defenseMod(tier) { return (DEF_WILL_TABLE[tier] ?? DEF_WILL_TABLE[1]).mod; }
  function willMod(tier)    { return (DEF_WILL_TABLE[tier] ?? DEF_WILL_TABLE[1]).mod; }
  function shootMod(tier)   { return (SHOOT_FIGHT_TABLE[tier] ?? SHOOT_FIGHT_TABLE[1]).mod; }
  function fightMod(tier)   { return (SHOOT_FIGHT_TABLE[tier] ?? SHOOT_FIGHT_TABLE[1]).mod; }

  function statPointsCost(m) {
    const d = (DEF_WILL_TABLE[m.defense] ?? DEF_WILL_TABLE[1]).cost;
    const w = (DEF_WILL_TABLE[m.will] ?? DEF_WILL_TABLE[1]).cost;
    const s = (SHOOT_FIGHT_TABLE[m.shoot] ?? SHOOT_FIGHT_TABLE[1]).cost;
    const f = (SHOOT_FIGHT_TABLE[m.fight] ?? SHOOT_FIGHT_TABLE[1]).cost;
    return d + w + s + f;
  }

  function woundsTotal(m) {
    return (m.defense ?? 0) + (m.shoot ?? 0) + (m.fight ?? 0) + (m.will ?? 0);
  }

  function equipmentCapacity(m) { return m.defense ?? 0; }
  function psychicMutationCapacity(m) { return m.will ?? 0; }
  function savingThrowTarget(m) { return clampMin((SAVE_TARGET_BY_WILL[m.will] ?? SAVE_TARGET_BY_WILL[1]), 10); }
  function armorClass(m) { return 10 + defenseMod(m.defense ?? 1); }

  // Warband state: leader + 4 models
  const warband = {
    version: 3,
    pointCap: 75,
    warbandTraitIdx: "",
    leaderTraitIdx: "",

    members: [
      { role: "Leader", defense: 1, shoot: 1, fight: 1, will: 1, weaponIdx: "", sidearmIdx: "", accessoryIdx: [], psychicIdx: [], mutationIdx: [], weaponIdx: [] },
      { role: "Model 1", defense: 1, shoot: 1, fight: 1, will: 1, weaponIdx: "", sidearmIdx: "", accessoryIdx: [], psychicIdx: [], mutationIdx: [], weaponIdx: [] },
      { role: "Model 2", defense: 1, shoot: 1, fight: 1, will: 1, weaponIdx: "", sidearmIdx: "", accessoryIdx: [], psychicIdx: [], mutationIdx: [], weaponIdx: []  },
      { role: "Model 3", defense: 1, shoot: 1, fight: 1, will: 1, weaponIdx: "", sidearmIdx: "", accessoryIdx: [], psychicIdx: [], mutationIdx: [], weaponIdx: []  },
      { role: "Model 4", defense: 1, shoot: 1, fight: 1, will: 1, weaponIdx: "", sidearmIdx: "", accessoryIdx: [], psychicIdx: [], mutationIdx: [], weaponIdx: []  },
    ]
  };

  function memberWeaponPoints(m) {
    let sum = 0;

    if (m.weaponIdx !== "" && m.weaponIdx !== null && m.weaponIdx !== undefined) {
      const w = weapons[Number(m.weaponIdx)];
      sum += toIntOrNull(w?.points) ?? 0;
    }

    if ((m.shoot ?? 0) >= SIDEARM_UNLOCK_SHOOT_TIER &&
        m.sidearmIdx !== "" && m.sidearmIdx !== null && m.sidearmIdx !== undefined) {
      const s = weapons[Number(m.sidearmIdx)];
      sum += toIntOrNull(s?.points) ?? 0;
    }

        // Melee weapon points
    if (m.meleeIdx !== "" && m.meleeIdx !== null && m.meleeIdx !== undefined) {
      const mw = meleeWeapons[Number(m.meleeIdx)];
      sum += toIntOrNull(mw?.points) ?? 0;
    }

    
    return sum;
  }

  function memberAccessoryPoints(m) {
    let sum = 0;
    for (const idx of (m.accessoryIdx || [])) {
      const a = accessories[Number(idx)];
      sum += (toIntOrNull(a?.points) ?? 0);
    }
    return sum;
  }

  function memberPsiMutPoints(m) {
    let sum = 0;

    for (const idx of (m.psychicIdx || [])) {
      const p = psychicPowers[Number(idx)];
      sum += (toIntOrNull(p?.points) ?? 0);
    }

    for (const idx of (m.mutationIdx || [])) {
      const mu = mutations[Number(idx)];
      sum += (toIntOrNull(mu?.points) ?? 0);
    }

    return sum;
  }

  function memberTotalPoints(m) {
    return statPointsCost(m) + memberWeaponPoints(m) + memberAccessoryPoints(m) + memberPsiMutPoints(m);
  }

  function warbandTotalPoints() {
    return warband.members.reduce((acc, m) => acc + memberTotalPoints(m), 0);
  }

function warbandTraitPoints() { return 0; }
function leaderTraitPoints() { return 0; }

  

    function makeCollapsible(titleText, initiallyOpen = false) {
    const wrap = document.createElement("div");
    wrap.style.marginTop = "12px";
    wrap.style.border = "1px solid #eee";
    wrap.style.borderRadius = "10px";
    wrap.style.overflow = "hidden";

    const header = document.createElement("button");
    header.type = "button";
    header.style.width = "100%";
    header.style.textAlign = "left";
    header.style.padding = "10px 12px";
    header.style.border = "0";
    header.style.background = "#f7f7f7";
    header.style.cursor = "pointer";
    header.style.display = "flex";
    header.style.justifyContent = "space-between";
    header.style.alignItems = "center";
    header.style.gap = "10px";
    header.style.fontWeight = "800";

    const title = document.createElement("span");
    title.textContent = titleText;

    const chevron = document.createElement("span");
    chevron.textContent = initiallyOpen ? "▾" : "▸";
    chevron.style.opacity = "0.8";

    header.appendChild(title);
    header.appendChild(chevron);

    const body = document.createElement("div");
    body.style.padding = "10px 12px";
    body.style.display = initiallyOpen ? "block" : "none";
    body.style.background = "#fff";

    header.addEventListener("click", () => {
      const open = body.style.display !== "none";
      body.style.display = open ? "none" : "block";
      chevron.textContent = open ? "▸" : "▾";
    });

    wrap.appendChild(header);
    wrap.appendChild(body);

    return { wrap, body };
  }

  
  function setIoVisible(vis, title) {
    els.ioArea.style.display = vis ? "block" : "none";
    if (title) els.ioTitle.textContent = title;
    els.ioMsg.textContent = "";
  }

  function renderWarband() {
    warband.pointCap = toIntOrNull(els.pointCap.value) ?? 0;
    els.warbandGrid.innerHTML = "";

    warband.members.forEach((m, memberIndex) => {
      const card = document.createElement("div");
      card.style.border = "1px solid #ddd";
      card.style.borderRadius = "10px";
      card.style.padding = "14px";

      // Header
      const header = document.createElement("div");
      header.style.display = "flex";
      header.style.justifyContent = "space-between";
      header.style.alignItems = "baseline";
      header.style.gap = "10px";

      const title = document.createElement("div");
      title.style.fontWeight = "900";
      title.style.fontSize = "16px";
      title.textContent = m.role;

      const pts = document.createElement("div");
      pts.style.fontWeight = "800";
      pts.textContent = `${memberTotalPoints(m)} pts`;

      header.appendChild(title);
      header.appendChild(pts);
      card.appendChild(header);

      // Tier select helper (shows Tier + mod + cost)
      function tierSelect(label, key) {
        const wrap = document.createElement("div");
        wrap.style.display = "grid";
        wrap.style.gridTemplateColumns = "1fr 140px";
        wrap.style.gap = "8px";
        wrap.style.alignItems = "center";

        const l = document.createElement("div");
        l.innerHTML = `<strong>${escapeHtml(label)}</strong>`;

        const s = document.createElement("select");
        const tiers = [0, 1, 2, 3];
        const table =
          (key === "defense" || key === "will") ? DEF_WILL_TABLE :
          (key === "shoot" || key === "fight") ? SHOOT_FIGHT_TABLE :
          null;

        s.innerHTML = tiers.map(t => {
          const entry = table?.[t];
          const mod = entry?.mod ?? 0;
          const cost = entry?.cost ?? 0;
          const modStr = mod >= 0 ? `+${mod}` : `${mod}`;
          return `<option value="${t}">Tier ${t} (${modStr}, ${cost} pts)</option>`;
        }).join("");

        s.value = String(m[key] ?? 0);

        s.addEventListener("change", () => {
          m[key] = Number(s.value);
          if (key === "shoot" && (m.shoot ?? 0) < SIDEARM_UNLOCK_SHOOT_TIER) {
            m.sidearmIdx = "";
          }
          renderWarband();
        });

        wrap.appendChild(l);
        wrap.appendChild(s);
        return wrap;
      }

      // Stats block
      const statsBlock = document.createElement("div");
      statsBlock.style.marginTop = "10px";
      statsBlock.style.display = "grid";
      statsBlock.style.gridTemplateColumns = "repeat(2, minmax(0, 1fr))";
      statsBlock.style.gap = "10px";
      statsBlock.appendChild(tierSelect("Defense", "defense"));
      statsBlock.appendChild(tierSelect("Shoot", "shoot"));
      statsBlock.appendChild(tierSelect("Fight", "fight"));
      statsBlock.appendChild(tierSelect("Willpower", "will"));
      card.appendChild(statsBlock);

      // Derived stats panel
      const derived = document.createElement("div");
      derived.style.marginTop = "10px";
      derived.style.padding = "10px";
      derived.style.border = "1px solid #eee";
      derived.style.borderRadius = "10px";
      derived.style.background = "#fafafa";

      const statLine = (label, value) => {
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.justifyContent = "space-between";
        row.style.gap = "12px";
        row.style.marginTop = "4px";
        row.innerHTML = `<span style="color:#444;">${escapeHtml(label)}</span><span style="font-weight:700;">${escapeHtml(value)}</span>`;
        return row;
      };

      derived.appendChild(statLine("Armor Class (AC)", String(armorClass(m))));
      derived.appendChild(statLine("Saving Throw Target", String(savingThrowTarget(m))));
      derived.appendChild(statLine("Wounds", String(woundsTotal(m))));
      derived.appendChild(statLine("Equipment Capacity", `${(m.accessoryIdx || []).length}/${equipmentCapacity(m)}`));
      derived.appendChild(statLine("Psychic/Mutation Capacity", String(psychicMutationCapacity(m))));
      derived.appendChild(statLine("Stat Points", String(statPointsCost(m))));
      
      derived.appendChild(statLine("Defense Mod", String(defenseMod(m.defense ?? 1))));
      derived.appendChild(statLine("Shoot Mod", String(shootMod(m.shoot ?? 1))));
      derived.appendChild(statLine("Fight Mod", String(fightMod(m.fight ?? 1))));
      derived.appendChild(statLine("Willpower Mod", String(willMod(m.will ?? 1))));


      card.appendChild(derived);

      // Primary weapon select
      const weaponRow = document.createElement("div");
      weaponRow.style.marginTop = "12px";
      weaponRow.innerHTML = "<strong>Ranged Weapon</strong>";

      const sel = document.createElement("select");
      sel.style.width = "100%";
      sel.style.marginTop = "6px";
      sel.innerHTML =
        `<option value="">— None —</option>` +
        weapons.map((w, idx) => {
          const p = toIntOrNull(w.points) ?? 0;
          const nm = escapeHtml(w.name ?? "(Unnamed)");
          return `<option value="${idx}">${nm} (${p} pts)</option>`;
        }).join("");

      sel.value = m.weaponIdx === "" ? "" : String(m.weaponIdx);
      sel.addEventListener("change", () => {
        m.weaponIdx = sel.value === "" ? "" : sel.value;
        renderWarband();
      });

      weaponRow.appendChild(sel);
      card.appendChild(weaponRow);

      // Secondary sidearm select (Shoot >= 3)
      if ((m.shoot ?? 0) >= SIDEARM_UNLOCK_SHOOT_TIER) {
        const sidearmRow = document.createElement("div");
        sidearmRow.style.marginTop = "10px";
        sidearmRow.innerHTML = "<strong>Sidearm (Shoot Tier 3+)</strong>";

        const sidearms = weapons
          .map((w, idx) => ({ w, idx }))
          .filter(x =>
            String(x.w.name ?? "").toLowerCase().includes("sidearm") ||
            String(x.w.name ?? "").toLowerCase().includes("pistol")
          );

        const sideSel = document.createElement("select");
        sideSel.style.width = "100%";
        sideSel.style.marginTop = "6px";
        sideSel.innerHTML =
          `<option value="">— None —</option>` +
          sidearms.map(x => {
            const p = toIntOrNull(x.w.points) ?? 0;
            const nm = escapeHtml(x.w.name ?? "(Unnamed)");
            return `<option value="${x.idx}">${nm} (${p} pts)</option>`;
          }).join("");

        sideSel.value = m.sidearmIdx === "" ? "" : String(m.sidearmIdx);
        sideSel.addEventListener("change", () => {
          m.sidearmIdx = sideSel.value === "" ? "" : sideSel.value;
          renderWarband();
        });

        sidearmRow.appendChild(sideSel);
        card.appendChild(sidearmRow);
      }

            // Melee weapon select
      const meleeSection = document.createElement("div");
      meleeSection.style.marginTop = "12px";
      meleeSection.innerHTML = "<strong>Melee Weapon</strong>";

      const meleeSel = document.createElement("select");
      meleeSel.style.width = "100%";
      meleeSel.style.marginTop = "6px";
      meleeSel.innerHTML =
        `<option value="">— None —</option>` +
        meleeWeapons.map((w, idx) => {
          const p = toIntOrNull(w.points) ?? 0;
          const nm = escapeHtml(w.name ?? "(Unnamed)");
          return `<option value="${idx}">${nm} (${p} pts)</option>`;
        }).join("");

      meleeSel.value = m.meleeIdx === "" ? "" : String(m.meleeIdx);
      meleeSel.addEventListener("change", () => {
        m.meleeIdx = meleeSel.value === "" ? "" : meleeSel.value;
        renderWarband();
      });

      meleeSection.appendChild(meleeSel);
      card.appendChild(meleeSection);


      // Accessories
      const accSection = makeCollapsible("Accessories", false);
      const accWrap = accSection.body;


      const accCap = DEFENSE_TO_ACC_CAP[m.defense] ?? 0;
      const accUsed = (m.accessoryIdx || []).length;

      const capLine = document.createElement("div");
      capLine.style.marginTop = "6px";
      capLine.innerHTML = accUsed > accCap
        ? `<span style="color:#8a1f11; font-weight:700;">Over capacity: ${accUsed}/${accCap}</span>`
        : `<span style="color:#444;">Capacity: ${accUsed}/${accCap}</span>`;
      accWrap.appendChild(capLine);

      const list = document.createElement("div");
      list.style.marginTop = "6px";

      const selected = new Set((m.accessoryIdx || []).map(String));
      accessories.forEach((a, idx) => {
        const p = toIntOrNull(a.points) ?? 0;
        const name = a.name ?? "(Unnamed)";
        const id = `m${memberIndex}_a${idx}`;

        const line = document.createElement("div");
        line.style.marginBottom = "6px";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = id;
        cb.checked = selected.has(String(idx));
        cb.addEventListener("change", () => {
          const s = new Set((m.accessoryIdx || []).map(String));
          if (cb.checked) s.add(String(idx));
          else s.delete(String(idx));
          m.accessoryIdx = [...s].map(Number);
          renderWarband();
        });

        const lbl = document.createElement("label");
        lbl.htmlFor = id;
        lbl.style.cursor = "pointer";
        lbl.textContent = ` ${name} (${p} pts)`;

        line.appendChild(cb);
        line.appendChild(lbl);
        list.appendChild(line);
      });

      accWrap.appendChild(list);
      card.appendChild(accSection.wrap);


      // Psychic Powers + Mutations
      const psiSection = makeCollapsible("Psychic Powers + Mutations", false);
      const psiWrap = psiSection.body;


      const pmCap = psychicMutationCapacity(m);
      const pmUsed = (m.psychicIdx || []).length + (m.mutationIdx || []).length;

      const pmLine = document.createElement("div");
      pmLine.style.marginTop = "6px";
      pmLine.innerHTML = pmUsed > pmCap
        ? `<span style="color:#8a1f11; font-weight:700;">Over capacity: ${pmUsed}/${pmCap}</span>`
        : `<span style="color:#444;">Capacity: ${pmUsed}/${pmCap}</span>`;
      psiWrap.appendChild(pmLine);

      const psyTitle = document.createElement("div");
      psyTitle.style.marginTop = "8px";
      psyTitle.innerHTML = "<strong style='font-size:13px;'>Psychic Powers</strong>";
      psiWrap.appendChild(psyTitle);

      const psyList = document.createElement("div");
      psyList.style.marginTop = "6px";

      const psySelected = new Set((m.psychicIdx || []).map(String));
      psychicPowers.forEach((p, idx) => {
        const pts = toIntOrNull(p.points) ?? 0;
        const name = p.name ?? "(Unnamed)";
        const id = `m${memberIndex}_psy${idx}`;

        const line = document.createElement("div");
        line.style.marginBottom = "6px";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = id;
        cb.checked = psySelected.has(String(idx));
        cb.addEventListener("change", () => {
          const s = new Set((m.psychicIdx || []).map(String));
          if (cb.checked) s.add(String(idx));
          else s.delete(String(idx));
          m.psychicIdx = [...s].map(Number);
          renderWarband();
        });

        const lbl = document.createElement("label");
        lbl.htmlFor = id;
        lbl.style.cursor = "pointer";
        lbl.textContent = ` ${name} (${pts} pts)`;

        line.appendChild(cb);
        line.appendChild(lbl);
        psyList.appendChild(line);
      });

      psiWrap.appendChild(psyList);

      const mutTitle = document.createElement("div");
      mutTitle.style.marginTop = "10px";
      mutTitle.innerHTML = "<strong style='font-size:13px;'>Mutations</strong>";
      psiWrap.appendChild(mutTitle);

      const mutList = document.createElement("div");
      mutList.style.marginTop = "6px";

      const mutSelected = new Set((m.mutationIdx || []).map(String));
      mutations.forEach((mu, idx) => {
        const pts = toIntOrNull(mu.points) ?? 0;
        const name = mu.name ?? "(Unnamed)";
        const id = `m${memberIndex}_mut${idx}`;

        const line = document.createElement("div");
        line.style.marginBottom = "6px";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = id;
        cb.checked = mutSelected.has(String(idx));
        cb.addEventListener("change", () => {
          const s = new Set((m.mutationIdx || []).map(String));
          if (cb.checked) s.add(String(idx));
          else s.delete(String(idx));
          m.mutationIdx = [...s].map(Number);
          renderWarband();
        });

        const lbl = document.createElement("label");
        lbl.htmlFor = id;
        lbl.style.cursor = "pointer";
        lbl.textContent = ` ${name} (${pts} pts)`;

        line.appendChild(cb);
        line.appendChild(lbl);
        mutList.appendChild(line);
      });

      psiWrap.appendChild(mutList);
      card.appendChild(psiSection.wrap);

      els.warbandGrid.appendChild(card);
    });

    const total = warbandTotalPoints();
    els.warbandTotal.textContent = String(total);

    const cap = warband.pointCap;
    if (total > cap) {
      els.warbandCapStatus.innerHTML = `<span style="color:#8a1f11; font-weight:600;">Over cap by ${total - cap}</span>`;
    } else {
      els.warbandCapStatus.innerHTML = `<span style="color:#0b5; font-weight:600;">Within cap (${cap - total} left)</span>`;
    }
  }

  function exportWarband() {
    warband.pointCap = toIntOrNull(els.pointCap.value) ?? 0;
    setIoVisible(true, "Export Warband");
    els.ioText.value = JSON.stringify(warband, null, 2);
    els.ioMsg.textContent = "Copy this JSON to save/share the warband.";
  }

  function importWarbandUI() {
    setIoVisible(true, "Import Warband");
    els.ioText.value = "";
    els.ioMsg.textContent = "Paste a previously exported warband JSON, then click “Load Pasted JSON”.";
  }

  function loadPastedWarband() {
    try {
      const parsed = JSON.parse(els.ioText.value);
      if (!parsed || typeof parsed !== "object") throw new Error("Not an object");
      if (!Array.isArray(parsed.members)) throw new Error("Missing members[]");

      warband.version = parsed.version ?? warband.version;
      warband.pointCap = toIntOrNull(parsed.pointCap) ?? (toIntOrNull(els.pointCap.value) ?? warband.pointCap);

            warband.warbandTraitIdx = (parsed.warbandTraitIdx === "" || parsed.warbandTraitIdx === null || parsed.warbandTraitIdx === undefined)
        ? "" : String(parsed.warbandTraitIdx);

      warband.leaderTraitIdx = (parsed.leaderTraitIdx === "" || parsed.leaderTraitIdx === null || parsed.leaderTraitIdx === undefined)
        ? "" : String(parsed.leaderTraitIdx);


      const defaultMembers = warband.members.map(m => ({
        ...m, weaponIdx: "", sidearmIdx: "", meleeIdx: "", accessoryIdx: [], psychicIdx: [], mutationIdx: []
      }));
      const incoming = parsed.members.slice(0, defaultMembers.length);

      warband.members = defaultMembers.map((def, i) => {
        const inc = incoming[i] ?? {};
        return {
          role: def.role,
          defense: toIntOrNull(inc.defense) ?? def.defense,
          shoot: toIntOrNull(inc.shoot) ?? def.shoot,
          fight: toIntOrNull(inc.fight) ?? def.fight,
          will: toIntOrNull(inc.will) ?? def.will,
          weaponIdx: (inc.weaponIdx === "" || inc.weaponIdx === null || inc.weaponIdx === undefined) ? "" : String(inc.weaponIdx),
          sidearmIdx: (inc.sidearmIdx === "" || inc.sidearmIdx === null || inc.sidearmIdx === undefined) ? "" : String(inc.sidearmIdx),
          meleeIdx: (inc.meleeIdx === "" || inc.meleeIdx === null || inc.meleeIdx === undefined) ? "" : String(inc.meleeIdx),
          accessoryIdx: Array.isArray(inc.accessoryIdx) ? inc.accessoryIdx.map(Number).filter(n => Number.isFinite(n)) : [],
          psychicIdx: Array.isArray(inc.psychicIdx) ? inc.psychicIdx.map(Number).filter(n => Number.isFinite(n)) : [],
          mutationIdx: Array.isArray(inc.mutationIdx) ? inc.mutationIdx.map(Number).filter(n => Number.isFinite(n)) : [],
        };
      });

      els.pointCap.value = String(warband.pointCap);

      if (els.warbandTraitSelect) els.warbandTraitSelect.value = warband.warbandTraitIdx === "" ? "" : String(warband.warbandTraitIdx);
      if (els.leaderTraitSelect) els.leaderTraitSelect.value = warband.leaderTraitIdx === "" ? "" : String(warband.leaderTraitIdx);

      
      renderWarband();
      els.ioMsg.textContent = "Loaded warband successfully.";
    } catch (e) {
      els.ioMsg.textContent = `Import failed: ${String(e.message || e)}`;
    }
  }

  async function loadData() {
    try {
      const wRes = await fetch("./data/shoot.json", { cache: "no-store" });
      if (!wRes.ok) throw new Error(`HTTP ${wRes.status} when fetching shoot.json`);
      weapons = await wRes.json();
      if (!Array.isArray(weapons)) throw new Error("shoot.json must be an array of objects");

      const aRes = await fetch("./data/accessories.json", { cache: "no-store" });
      if (!aRes.ok) throw new Error(`HTTP ${aRes.status} when fetching accessories.json`);
      accessories = await aRes.json();
      if (!Array.isArray(accessories)) throw new Error("accessories.json must be an array of objects");

      const fRes = await fetch("./data/fight.json", { cache: "no-store" });
      if (!fRes.ok) throw new Error(`HTTP ${fRes.status} when fetching fight.json`);
      meleeWeapons = await fRes.json();
      if (!Array.isArray(meleeWeapons)) throw new Error("fight.json must be an array of objects");
      
      const pRes = await fetch("./data/psychic_powers.json", { cache: "no-store" });
      if (!pRes.ok) throw new Error(`HTTP ${pRes.status} when fetching psychic_powers.json`);
      psychicPowers = await pRes.json();
      if (!Array.isArray(psychicPowers)) throw new Error("psychic_powers.json must be an array of objects");

      const mRes = await fetch("./data/mutations.json", { cache: "no-store" });
      if (!mRes.ok) throw new Error(`HTTP ${mRes.status} when fetching mutations.json`);
      mutations = await mRes.json();
      if (!Array.isArray(mutations)) throw new Error("mutations.json must be an array of objects");

      const wtRes = await fetch("./data/warband_traits.json", { cache: "no-store" });
      if (!wtRes.ok) throw new Error(`HTTP ${wtRes.status} when fetching warband_traits.json`);
      warbandTraits = await wtRes.json();
      if (!Array.isArray(warbandTraits)) throw new Error("warband_traits.json must be an array of objects");

      const ltRes = await fetch("./data/leader_traits.json", { cache: "no-store" });
      if (!ltRes.ok) throw new Error(`HTTP ${ltRes.status} when fetching leader_traits.json`);
      leaderTraits = await ltRes.json();
      if (!Array.isArray(leaderTraits)) throw new Error("leader_traits.json must be an array of objects");

      weapons.sort((a, b) =>
        ((toIntOrNull(a.points) ?? 0) - (toIntOrNull(b.points) ?? 0)) ||
        String(a.name ?? "").localeCompare(String(b.name ?? ""))
      );
      accessories.sort((a, b) =>
        ((toIntOrNull(a.points) ?? 0) - (toIntOrNull(b.points) ?? 0)) ||
        String(a.name ?? "").localeCompare(String(b.name ?? ""))
      );
      psychicPowers.sort((a, b) =>
        ((toIntOrNull(a.points) ?? 0) - (toIntOrNull(b.points) ?? 0)) ||
        String(a.name ?? "").localeCompare(String(b.name ?? ""))
      );
      mutations.sort((a, b) =>
        ((toIntOrNull(b.points) ?? 0) - (toIntOrNull(a.points) ?? 0)) ||
        String(a.name ?? "").localeCompare(String(b.name ?? ""))
      );
      meleeWeapons.sort((a, b) =>
        ((toIntOrNull(a.points) ?? 0) - (toIntOrNull(b.points) ?? 0)) ||
        String(a.name ?? "").localeCompare(String(b.name ?? ""))
      );

            warbandTraits.sort((a, b) =>
        ((toIntOrNull(a.points) ?? 0) - (toIntOrNull(b.points) ?? 0)) ||
        String(a.name ?? "").localeCompare(String(b.name ?? ""))
      );

      leaderTraits.sort((a, b) =>
        ((toIntOrNull(a.points) ?? 0) - (toIntOrNull(b.points) ?? 0)) ||
        String(a.name ?? "").localeCompare(String(b.name ?? ""))
      );


      // IO buttons
      els.exportBtn.addEventListener("click", exportWarband);
      els.importBtn.addEventListener("click", importWarbandUI);
      els.closeIoBtn.addEventListener("click", () => setIoVisible(false));
      els.copyBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(els.ioText.value);
          els.ioMsg.textContent = "Copied to clipboard.";
        } catch {
          els.ioMsg.textContent = "Could not copy automatically — select all and copy manually.";
        }
      });
      els.loadBtn.addEventListener("click", loadPastedWarband);
      // Warband Trait select
      els.warbandTraitSelect.innerHTML =
        `<option value="">— None —</option>` +
        warbandTraits.map((t, idx) => {
          const p = toIntOrNull(t.points) ?? 0;
          const nm = escapeHtml(t.name ?? "(Unnamed)");
          return `<option value="${idx}">${nm} (${p} pts)</option>`;
        }).join("");

      els.warbandTraitSelect.value = warband.warbandTraitIdx === "" ? "" : String(warband.warbandTraitIdx);
      els.warbandTraitSelect.addEventListener("change", () => {
        warband.warbandTraitIdx = els.warbandTraitSelect.value === "" ? "" : els.warbandTraitSelect.value;
        renderWarband();
      });

      // Leader Trait select
      els.leaderTraitSelect.innerHTML =
        `<option value="">— None —</option>` +
        leaderTraits.map((t, idx) => {
          const p = toIntOrNull(t.points) ?? 0;
          const nm = escapeHtml(t.name ?? "(Unnamed)");
          return `<option value="${idx}">${nm} (${p} pts)</option>`;
        }).join("");

      els.leaderTraitSelect.value = warband.leaderTraitIdx === "" ? "" : String(warband.leaderTraitIdx);
      els.leaderTraitSelect.addEventListener("change", () => {
        warband.leaderTraitIdx = els.leaderTraitSelect.value === "" ? "" : els.leaderTraitSelect.value;
        renderWarband();
      });

      renderWarband();
    } catch (err) {
      els.errorCard.style.display = "block";
      els.errorText.textContent = String(err);
      console.error(err);
    }
  }

  loadData();
</script>

</body>
</html>
